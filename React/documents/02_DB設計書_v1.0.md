# 施設管理システム DB設計書

## 1. 概要

### 1.1 目的
本ドキュメントは、施設管理システムのデータベース設計を定義する。

### 1.2 データベース情報
| 項目 | 値 |
|------|-----|
| DBMS | PostgreSQL（Supabase） |
| プロジェクト名 | facility_management |
| リージョン | Northeast Asia (Tokyo) |

### 1.3 設計方針
- Supabase Authと連携したユーザー管理
- RLS（Row Level Security）によるアクセス制御
- 将来のマルチテナント対応を考慮（tenant_id）
- 論理削除ではなくステータス管理（reservations.status）

---

## 2. ER図

```
┌─────────────────┐
│   auth.users    │ ← Supabase Auth（自動管理）
│     (UUID)      │
└────────┬────────┘
         │ 1:1
         ▼
┌─────────────────┐       ┌─────────────────┐
│    profiles     │       │ module_settings │
│  ユーザー情報    │       │  モジュール設定  │
└────────┬────────┘       └─────────────────┘
         │
         │ 1:N
         ▼
┌─────────────────┐       ┌─────────────────┐
│  reservations   │◄──────│   facilities    │
│      予約       │  N:1  │      施設       │
└─────────────────┘       └────────┬────────┘
                                   │ N:1
                                   ▼
                          ┌─────────────────┐
                          │   categories    │
                          │   カテゴリ      │
                          └─────────────────┘
```

### Phase2以降のテーブル関係
```
┌─────────────────┐       ┌─────────────────┐
│  reservations   │──────►│reservation_items│◄──────┐
│      予約       │  1:N  │  予約備品       │  N:1  │
└─────────────────┘       └─────────────────┘       │
                                                    │
                          ┌─────────────────┐       │
                          │     items       │───────┘
                          │     備品        │
                          └─────────────────┘

┌─────────────────┐       ┌─────────────────┐
│    profiles     │──────►│   inquiries     │──────►┌─────────────────┐
│  ユーザー情報   │  1:N  │  問い合わせ     │  1:N  │inquiry_messages │
└─────────────────┘       └─────────────────┘       │  メッセージ     │
                                                    └─────────────────┘
```

---

## 3. テーブル定義

### 3.1 Phase1 テーブル（コア機能）

---

#### 3.1.1 profiles（ユーザー情報）

Supabase Authのusersテーブルと1:1で連携するユーザー情報テーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | - | PK, auth.users.id参照 |
| email | TEXT | NO | - | メールアドレス |
| display_name | TEXT | YES | NULL | 表示名 |
| role | TEXT | NO | 'user' | 権限（user/admin/developer） |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (id) REFERENCES auth.users(id) ON DELETE CASCADE
- CHECK (role IN ('user', 'admin', 'developer'))

**インデックス:**
- なし（PKのみ）

---

#### 3.1.2 categories（カテゴリ）

施設を分類するカテゴリマスタ。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| name | TEXT | NO | - | カテゴリ名 |
| sort_order | INTEGER | NO | 0 | 表示順 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |

**制約:**
- PRIMARY KEY (id)

**インデックス:**
- idx_categories_sort_order (sort_order)

---

#### 3.1.3 facilities（施設）

予約対象となる施設（部屋・スペース）の情報。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| category_id | INTEGER | YES | NULL | FK: カテゴリID |
| name | TEXT | NO | - | 施設名 |
| max_capacity | INTEGER | NO | 1 | 最大収容人数 |
| equipment | TEXT | YES | NULL | 設備情報 |
| time_unit | INTEGER | NO | 30 | 予約単位（分） |
| allow_extension | BOOLEAN | NO | FALSE | 時間延長可否 |
| is_active | BOOLEAN | NO | TRUE | 利用可否 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE SET NULL

**インデックス:**
- idx_facilities_category_id (category_id)
- idx_facilities_is_active (is_active)

---

#### 3.1.4 reservations（予約）

施設の予約情報を管理するテーブル。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| user_id | UUID | NO | - | FK: 予約者ID |
| facility_id | INTEGER | NO | - | FK: 施設ID |
| start_time | TIMESTAMPTZ | NO | - | 開始日時 |
| end_time | TIMESTAMPTZ | NO | - | 終了日時 |
| num_people | INTEGER | NO | 1 | 利用人数 |
| purpose | TEXT | YES | NULL | 利用目的 |
| status | TEXT | NO | 'confirmed' | ステータス |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE
- FOREIGN KEY (facility_id) REFERENCES facilities(id) ON DELETE CASCADE
- CHECK (status IN ('confirmed', 'cancelled', 'completed'))
- CHECK (end_time > start_time)

**インデックス:**
- idx_reservations_user_id (user_id)
- idx_reservations_facility_id (facility_id)
- idx_reservations_start_time (start_time)
- idx_reservations_status (status)

**ステータス遷移:**
```
[confirmed] ──キャンセル──→ [cancelled]
     │
     │利用終了時刻経過
     ↓
[completed]
```

---

#### 3.1.5 module_settings（モジュール設定）

システムのモジュールON/OFF設定を管理。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| module_id | TEXT | NO | - | モジュールID（一意） |
| is_enabled | BOOLEAN | NO | FALSE | 有効/無効 |
| config | JSONB | YES | '{}' | 追加設定 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- UNIQUE (module_id)

**初期データ:**
| module_id | is_enabled | 説明 |
|-----------|-----------|------|
| M-CORE | TRUE | コアシステム（固定） |
| M-USER | TRUE | ユーザー管理（固定） |
| M-FACILITY | TRUE | 施設管理（固定） |
| M-RESERVE | TRUE | 予約機能 |
| M-EXTEND | FALSE | 時間延長 |
| M-DISPLAY | FALSE | 表示機能 |
| M-PRICE | FALSE | 料金計算 |
| M-ITEM | FALSE | 備品管理 |
| M-INQUIRY | FALSE | 問い合わせ |
| M-NOTIFY | FALSE | 通知機能 |
| M-TENANT | FALSE | マルチテナント |

---

### 3.2 Phase2 テーブル（拡張機能）

---

#### 3.2.1 facility_prices（施設料金）

施設ごとの料金設定。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| facility_id | INTEGER | NO | - | FK: 施設ID |
| price_per_unit | INTEGER | NO | 0 | 単位時間あたり料金（円） |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (facility_id) REFERENCES facilities(id) ON DELETE CASCADE
- UNIQUE (facility_id)

---

#### 3.2.2 reservation_prices（予約料金）

予約ごとの料金記録。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| reservation_id | INTEGER | NO | - | FK: 予約ID |
| subtotal | INTEGER | NO | 0 | 合計金額（円） |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE
- UNIQUE (reservation_id)

---

#### 3.2.3 items（備品）

貸出可能な備品マスタ。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| name | TEXT | NO | - | 備品名 |
| total_quantity | INTEGER | NO | 1 | 総数 |
| rental_price | INTEGER | YES | NULL | 貸出単価（円） |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)

---

#### 3.2.4 reservation_items（予約備品）

予約に紐づく備品の貸出情報。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| reservation_id | INTEGER | NO | - | FK: 予約ID |
| item_id | INTEGER | NO | - | FK: 備品ID |
| quantity | INTEGER | NO | 1 | 貸出数 |
| rental_price | INTEGER | NO | 0 | 貸出時点の単価 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (reservation_id) REFERENCES reservations(id) ON DELETE CASCADE
- FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE RESTRICT

---

#### 3.2.5 inquiries（問い合わせ）

問い合わせのスレッド情報。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| user_id | UUID | NO | - | FK: 投稿者ID |
| subject | TEXT | NO | - | 件名 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (user_id) REFERENCES profiles(id) ON DELETE CASCADE

---

#### 3.2.6 inquiry_messages（問い合わせメッセージ）

問い合わせのメッセージ（チャット形式）。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | SERIAL | NO | - | PK |
| inquiry_id | INTEGER | NO | - | FK: 問い合わせID |
| sender_id | UUID | NO | - | FK: 送信者ID |
| sender_type | TEXT | NO | - | 送信者種別（user/admin） |
| message | TEXT | NO | - | メッセージ本文 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |

**制約:**
- PRIMARY KEY (id)
- FOREIGN KEY (inquiry_id) REFERENCES inquiries(id) ON DELETE CASCADE
- FOREIGN KEY (sender_id) REFERENCES profiles(id) ON DELETE CASCADE
- CHECK (sender_type IN ('user', 'admin'))

---

### 3.3 Phase3 テーブル（高度な機能）

---

#### 3.3.1 tenants（テナント）

マルチテナント対応時の組織情報。

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|---------|---------|------|-----------|------|
| id | UUID | NO | gen_random_uuid() | PK |
| name | TEXT | NO | - | テナント名 |
| subdomain | TEXT | NO | - | サブドメイン |
| is_active | BOOLEAN | NO | TRUE | 有効/無効 |
| created_at | TIMESTAMPTZ | NO | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NO | NOW() | 更新日時 |

**制約:**
- PRIMARY KEY (id)
- UNIQUE (subdomain)

---

## 4. RLS（Row Level Security）ポリシー

### 4.1 profiles

| ポリシー名 | 操作 | 条件 |
|-----------|------|------|
| profiles_select_all | SELECT | 全員閲覧可 |
| profiles_update_own | UPDATE | 自分のみ編集可 |

### 4.2 categories

| ポリシー名 | 操作 | 条件 |
|-----------|------|------|
| categories_select_all | SELECT | 全員閲覧可 |
| categories_insert_admin | INSERT | admin/developerのみ |
| categories_update_admin | UPDATE | admin/developerのみ |
| categories_delete_admin | DELETE | admin/developerのみ |

### 4.3 facilities

| ポリシー名 | 操作 | 条件 |
|-----------|------|------|
| facilities_select_all | SELECT | 全員閲覧可 |
| facilities_insert_admin | INSERT | admin/developerのみ |
| facilities_update_admin | UPDATE | admin/developerのみ |
| facilities_delete_admin | DELETE | admin/developerのみ |

### 4.4 reservations

| ポリシー名 | 操作 | 条件 |
|-----------|------|------|
| reservations_select_all | SELECT | 全員閲覧可 |
| reservations_insert_own | INSERT | 自分の予約のみ |
| reservations_update_own | UPDATE | 自分の予約のみ |
| reservations_delete_own | DELETE | 自分の予約のみ |

### 4.5 module_settings

| ポリシー名 | 操作 | 条件 |
|-----------|------|------|
| module_settings_select_all | SELECT | 全員閲覧可 |
| module_settings_update_developer | UPDATE | developerのみ |

---

## 5. トリガー・関数

### 5.1 handle_new_user

**目的:** 新規ユーザー登録時にprofilesテーブルへ自動挿入

**トリガー:** auth.users INSERT後

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, display_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'display_name', split_part(NEW.email, '@', 1)),
    'user'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
```

---

## 6. 補足事項

### 6.1 命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| テーブル名 | スネークケース（複数形） | profiles, reservations |
| カラム名 | スネークケース | created_at, user_id |
| 外部キー | 参照先テーブル名_id | facility_id |
| インデックス | idx_テーブル名_カラム名 | idx_reservations_user_id |

### 6.2 タイムゾーン

すべてのTIMESTAMPはTIMESTAMPTZ（タイムゾーン付き）を使用。
アプリケーション側でAsia/Tokyoに変換して表示。

### 6.3 将来の拡張（tenant_id）

Phase3でマルチテナント対応する際、以下のテーブルにtenant_idカラムを追加予定:
- profiles
- categories
- facilities
- reservations
- items
- inquiries
- module_settings

---

## 改訂履歴

| 版 | 日付 | 内容 | 作成者 |
|----|------|------|--------|
| 1.0 | 2026/01/09 | 初版作成 | Claude |
